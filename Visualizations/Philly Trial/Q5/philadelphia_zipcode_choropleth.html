<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Philadelphia Metro Restaurant Investment Readiness</title>
    
    <!-- import required libraries -->
    <script type="text/javascript" src="../lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="../lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="../lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="../lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="../lib/topojson.v2.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .title-section {
            flex: 1;
        }
        
        h1 {
            font-size: 24px;
            margin: 5px 0;
            color: #2c3e50;
        }
        
        h2 {
            font-size: 14px;
            margin: 0;
            color: #7f8c8d;
            font-weight: normal;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        #yearDropdown {
            font-size: 14px;
            padding: 6px 12px;
            border: 2px solid #3498db;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            color: #2c3e50;
        }
        
        #yearDropdown:hover {
            border-color: #2980b9;
            background-color: #ecf0f1;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
        
        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #bdc3c7;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
        }
        
        .zoom-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .map-container {
            flex: 1;
            position: relative;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #choropleth {
            width: 100%;
            height: 100%;
        }
        
        .zipcode {
            stroke: #fff;
            stroke-width: 0.5;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        
        .zipcode:hover {
            stroke: #2c3e50;
            stroke-width: 2;
        }
        
        #tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 13px;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 280px;
        }
        
        #tooltip strong {
            color: #3498db;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .legend-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
            color: #34495e;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #7f8c8d;
            border-radius: 2px;
        }
        
        .info-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            width: 200px;
        }
        
        .info-box h3 {
            margin-top: 0;
            font-size: 14px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .info-box p {
            margin: 5px 0;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .info-box p strong {
            color: #2c3e50;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="title-section">
                <h1>Philadelphia Metro Restaurant Investment Map</h1>
                <h2>Investment opportunity scores by ZIP code for Greater Philadelphia Area</h2>
            </div>
            <div class="controls">
                <div>
                    <label for="yearDropdown" style="font-size: 14px; color: #2c3e50;">Year: </label>
                    <select id="yearDropdown"></select>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
                    <button class="zoom-btn" id="zoom-reset" title="Reset">⟲</button>
                    <button class="zoom-btn" id="zoom-out" title="Zoom Out">−</button>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <svg id="choropleth"></svg>
            
            <div class="info-box">
                <h3>Investment Guide</h3>
                <p><strong>9-10:</strong> Prime Location</p>
                <p><strong>7-8:</strong> High Potential</p>
                <p><strong>5-6:</strong> Moderate Risk</p>
                <p><strong>3-4:</strong> High Risk</p>
                <p><strong>Below 3:</strong> Not Recommended</p>
            </div>
            
            <div class="legend" id="legend"></div>
        </div>
    </div>
    
    <div id="tooltip"></div>

    <script>
        // Get container dimensions
        const container = document.querySelector('.map-container');
        const containerRect = container.getBoundingClientRect();
        
        const width = containerRect.width;
        const height = containerRect.height;
        
        // Create SVG with viewBox
        const svg = d3.select("#choropleth")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");
        
        // Create a group for zooming
        const g = svg.append("g");
        
        // Create main group for ZIP codes
        const zipCodesGroup = g.append("g")
            .attr("id", "zipcodes");
        
        // Create tooltip
        const tooltip = d3.select("#tooltip");
        
        // Create color scale - green to red for investment scores
        const colorScale = d3.scaleThreshold()
            .domain([3, 5, 6, 7, 8, 9])
            .range([
                "#e74c3c",  // Red (1-3: High risk)
                "#e67e22",  // Orange (3-5: Below average)
                "#f39c12",  // Yellow-orange (5-6: Average)
                "#f1c40f",  // Yellow (6-7: Above average)
                "#2ecc71",  // Light green (7-8: Good)
                "#27ae60",  // Green (8-9: Very good)
                "#16a085"   // Dark green (9-10: Excellent)
            ]);
        
        const noDataColor = "#bdc3c7";
        
        // Define projection for Philadelphia region
        // Philadelphia coordinates: 39.9526° N, 75.1652° W
        var projection = d3.geoMercator()
            .center([-75.1652, 39.9526])
            .scale(25000)  // Adjust based on zoom level needed
            .translate([width / 2, height / 2]);
            
        var path = d3.geoPath()
            .projection(projection);
        
        // Define zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.5, 25])
            .on("zoom", zoomed);
        
        svg.call(zoom);
        
        function zoomed() {
            g.attr("transform", d3.event.transform);
            const zoomScale = d3.event.transform.k;
            zipCodesGroup.selectAll(".zipcode")
                .style("stroke-width", 0.5 / zoomScale);
        }
        
        // Zoom controls
        d3.select("#zoom-in").on("click", function() {
            zoom.scaleBy(svg.transition().duration(300), 1.3);
        });
        
        d3.select("#zoom-out").on("click", function() {
            zoom.scaleBy(svg.transition().duration(300), 0.7);
        });
        
        d3.select("#zoom-reset").on("click", function() {
            svg.transition().duration(300)
                .call(zoom.transform, d3.zoomIdentity);
        });

        // Global variables
        let geoData;
        let restaurantFullData;
        let yearDropdown = d3.select("#yearDropdown");

        Promise.all([
            d3.json("https://raw.githubusercontent.com/OpenDataDE/State-zip-code-GeoJSON/master/pa_pennsylvania_zip_codes_geo.min.json"),
            d3.csv("philadelphia_restaurant_readiness.csv")
        ]).then(function(files) {
            ready(null, files[0], files[1]);
        }).catch(function(error) {
            console.error("Error loading files:", error);
            
            // Try loading from local files if CDN fails
            Promise.all([
                d3.json("philadelphia_zipcodes.json"),
                d3.csv("philadelphia_restaurant_readiness.csv")
            ]).then(function(files) {
                ready(null, files[0], files[1]);
            }).catch(function(localError) {
                console.error("Error loading local files:", localError);
                alert("Error loading data files. Please check that philadelphia_zipcodes.json exists.");
            });
        });
        
        function ready(error, pennsylvania, restaurantData) {
            if (error) {
                console.error("Error loading data:", error);
                return;
            }
            
            geoData = pennsylvania;
            restaurantFullData = restaurantData;
            
            // Process the data
            restaurantData.forEach(d => {
                d.Year = +d.Year;
                d.ZipCode = String(d.ZipCode);  // Ensure string
                d.Investment_Score = +d.Investment_Score;
                d.Avg_Revenue_Potential = +d.Avg_Revenue_Potential;
            });
            
            // Get unique years
            const yearsSet = new Set(restaurantData.map(d => d.Year));
            const years = Array.from(yearsSet).sort((a, b) => b - a);
            
            // Populate dropdown
            yearDropdown
                .selectAll("option")
                .data(years)
                .enter()
                .append("option")
                .attr("value", d => d)
                .text(d => d);
            
            yearDropdown.property("value", years[0]);
            
            // Add event listener
            yearDropdown.on("change", function() {
                const selectedYear = +this.value;
                createMapAndLegend(geoData, restaurantFullData, selectedYear);
            });
            
            // Create initial map
            createMapAndLegend(geoData, restaurantFullData, years[0]);
        }

        function createMapAndLegend(geoJSON, restaurantData, selectedYear) {
            console.log(`Creating Philadelphia map for year: ${selectedYear}`);
            
            // Filter data for selected year
            const yearData = restaurantData.filter(d => d.Year === selectedYear);
            
            // Create lookup maps
            const scoresByZip = {};
            const dataByZip = {};
            yearData.forEach(d => {
                const zip = String(d.ZipCode);
                scoresByZip[zip] = d.Investment_Score;
                dataByZip[zip] = d;
                
                // Also try with leading zeros for 4-digit NJ zips
                if (zip.length === 4) {
                    const paddedZip = '0' + zip;
                    scoresByZip[paddedZip] = d.Investment_Score;
                    dataByZip[paddedZip] = d;
                }
            });
            
            // Clear previous map
            zipCodesGroup.selectAll("*").remove();
            
            // Filter to only Philadelphia region ZIPs
            const phillyZips = new Set(yearData.map(d => String(d.ZipCode)));
            const phillyFeatures = geoJSON.features.filter(f => {
                const zipCode = f.properties.ZCTA5CE10 || f.properties.ZIP || f.properties.zipcode || f.properties.GEOID10;
                return phillyZips.has(String(zipCode)) || phillyZips.has(String(parseInt(zipCode)));
            });
            
            // Draw ZIP codes
            zipCodesGroup.selectAll("path")
                .data(phillyFeatures)
                .enter()
                .append("path")
                .attr("class", "zipcode")
                .attr("d", path)
                .style("fill", function(d) {
                    const zipCode = String(d.properties.ZCTA5CE10 || d.properties.ZIP || d.properties.zipcode || d.properties.GEOID10);
                    const score = scoresByZip[zipCode] || scoresByZip[String(parseInt(zipCode))];
                    
                    if (score === undefined || score === null || isNaN(score)) {
                        return noDataColor;
                    }
                    return colorScale(score);
                })
                .on("mouseover", function(d) {
                    const zipCode = String(d.properties.ZCTA5CE10 || d.properties.ZIP || d.properties.zipcode || d.properties.GEOID10);
                    const data = dataByZip[zipCode] || dataByZip[String(parseInt(zipCode))];
                    
                    let tooltipHtml = `<strong>ZIP: ${zipCode}</strong><br/>`;
                    
                    if (data) {
                        tooltipHtml += `<strong>${data.Neighborhood || 'Area'}</strong><br/>
                                       Year: ${selectedYear}<br/>
                                       Investment Score: <strong style="color: #3498db">${data.Investment_Score}/10</strong><br/>
                                       Revenue Potential: <strong>$${data.Avg_Revenue_Potential.toLocaleString()}</strong><br/>
                                       Market Saturation: ${data.Market_Saturation}<br/>
                                       Population Density: ${data.Population_Density}`;
                    } else {
                        tooltipHtml += `No data available`;
                    }
                    
                    tooltip.style("display", "block")
                        .html(tooltipHtml);
                })
                .on("mousemove", function() {
                    tooltip.style("left", (d3.event.pageX + 10) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                });
            
            // Fit the map to the data
            const bounds = path.bounds({type: "FeatureCollection", features: phillyFeatures});
            const dx = bounds[1][0] - bounds[0][0];
            const dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2;
            const y = (bounds[0][1] + bounds[1][1]) / 2;
            const scale = Math.max(1, Math.min(8, 0.9 / Math.max(dx / width, dy / height)));
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
            
            updateLegend();
        }
        
        function updateLegend() {
            const legendContainer = d3.select("#legend");
            legendContainer.selectAll("*").remove();
            
            legendContainer.append("div")
                .attr("class", "legend-title")
                .text("Investment Score");
            
            const legendData = [
                { color: "#16a085", label: "9-10 (Prime)" },
                { color: "#27ae60", label: "8-9 (Excellent)" },
                { color: "#2ecc71", label: "7-8 (Good)" },
                { color: "#f1c40f", label: "6-7 (Above Avg)" },
                { color: "#f39c12", label: "5-6 (Average)" },
                { color: "#e67e22", label: "3-5 (Below Avg)" },
                { color: "#e74c3c", label: "1-3 (Poor)" },
                { color: noDataColor, label: "No data" }
            ];
            
            legendData.forEach(item => {
                const legendItem = legendContainer.append("div")
                    .attr("class", "legend-item");
                
                legendItem.append("div")
                    .attr("class", "legend-color")
                    .style("background-color", item.color);
                
                legendItem.append("span")
                    .text(item.label);
            });
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const newRect = container.getBoundingClientRect();
            const newWidth = newRect.width;
            const newHeight = newRect.height;
            
            svg.attr("viewBox", `0 0 ${newWidth} ${newHeight}`);
            
            projection.translate([newWidth / 2, newHeight / 2]);
            
            zipCodesGroup.selectAll(".zipcode")
                .attr("d", path);
        });
    </script>

</body>
</html>